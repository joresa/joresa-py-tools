{% extends 'base.html' %}
{% block content %}
<div class="container">
    <h2>Compare Result - Session {{ session.id }}</h2>
    <p>Source A: {{ session.meta.file_a }} | Source B: {{ session.meta.file_b }}</p>
    <a class="btn btn-sm btn-outline-primary"
        href="{{ url_for('tools.wp_db_compare_export', session_id=session.id) }}">Export SQL Summary</a>

    <div class="mt-4">
        <h4>Tables</h4>
        <ul class="list-group">
            {% for t, info in session.tables.items() %}
            <li class="list-group-item">
                <strong>{{ t }}</strong>
                <span class="badge bg-success ms-2">+{{ info.added_count }}</span>
                <span class="badge bg-danger ms-2">-{{ info.removed_count }}</span>
                <span class="badge bg-warning ms-2">~{{ info.modified_count }}</span>
                <a class="btn btn-sm btn-link" href="#table-{{ loop.index }}">View</a>
            </li>
            {% endfor %}
        </ul>

        {% for t, info in session.tables.items() %}
        <div id="table-{{ loop.index }}" class="mt-3">
            <h5>{{ t }}</h5>
            <h6>Modified rows</h6>
            {% if info.modified|length == 0 %}
            <p>No modified rows</p>
            {% else %}
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Key</th>
                        <th>Fields Changed</th>
                    </tr>
                </thead>
                <tbody>
                    {% for m in info.modified %}
                    <tr>
                        <td>{{ m.key }}</td>
                        <td>
                            {% for col, diff in m.diffs.items() %}
                            <div><strong>{{ col }}</strong>: <small class="text-muted">A={{ diff.a }}</small> â†’ <small
                                    class="text-muted">B={{ diff.b }}</small></div>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}